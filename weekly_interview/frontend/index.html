<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Interview System</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
      color: #e0e0e0;
      text-align: center;
      min-height: 100vh;
    }

    .header {
      padding: 30px;
      background: rgba(24, 24, 24, 0.9);
      border-bottom: 2px solid #333;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }

    h1 {
      margin: 0;
      font-size: 32px;
      color: #ffffff;
      letter-spacing: 2px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    h2 {
      font-weight: 400;
      color: #64b5f6;
      margin: 10px 0;
      font-size: 20px;
    }

    .main-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 80px;
      margin: 60px auto;
      max-width: 1200px;
    }

    .column {
      width: 200px;
      height: 200px;
      background: linear-gradient(145deg, #1c1c1c, #2a2a2a);
      border-radius: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .column:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8);
    }

    .icon {
      width: 90px;
      height: 90px;
      opacity: 0.8;
      transition: all 0.3s ease;
    }

    .icon.blink {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; filter: hue-rotate(0deg); }
      50% { transform: scale(1.1); opacity: 0.7; filter: hue-rotate(90deg); }
      100% { transform: scale(1); opacity: 1; filter: hue-rotate(0deg); }
    }

    #status {
      margin: 30px auto;
      font-size: 18px;
      color: #64b5f6;
      max-width: 600px;
      padding: 15px;
      background: rgba(100, 181, 246, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(100, 181, 246, 0.3);
    }

    .controls {
      margin: 30px 0;
    }

    button {
      margin: 10px 15px;
      padding: 15px 30px;
      border-radius: 12px;
      background: linear-gradient(145deg, #2196f3, #1976d2);
      color: #fff;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    button:hover {
      background: linear-gradient(145deg, #1976d2, #1565c0);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #424242;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    #evaluation {
      margin: 40px auto;
      max-width: 900px;
      padding: 30px;
      background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
      border-radius: 15px;
      color: #e0e0e0;
      display: none;
      text-align: left;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid #333;
    }

    #evaluation h3 {
      color: #64b5f6;
      margin-bottom: 20px;
      text-align: center;
      font-size: 24px;
    }

    #summaryText {
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 16px;
      color: #ccc;
    }

    .progress-indicator {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .round-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #424242;
      transition: all 0.3s ease;
    }

    .round-dot.active {
      background: #64b5f6;
      transform: scale(1.2);
      box-shadow: 0 0 10px rgba(100, 181, 246, 0.5);
    }

    .round-dot.completed {
      background: #4caf50;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(100, 181, 246, 0.3);
      border-radius: 50%;
      border-top-color: #64b5f6;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>AI Interview System</h1>
    <h2 id="roundLabel">Ready to Begin</h2>
    
    <div class="progress-indicator">
      <div class="round-dot" id="tech-dot" title="Technical"></div>
      <div class="round-dot" id="comm-dot" title="Communication"></div>
      <div class="round-dot" id="hr-dot" title="HR"></div>
    </div>
  </div>

  <div class="main-container">
    <div class="column">
      <img src="/static/icons/ai.png" id="aiIcon" class="icon" alt="AI" />
    </div>
    <div class="column">
      <img src="/static/icons/user.png" id="userIcon" class="icon" alt="User" />
    </div>
  </div>

  <div id="status">Click "Start Interview" to begin your AI-powered interview experience</div>

  <div class="controls">
    <button id="startInterviewBtn" onclick="startInterview()">üéØ Start Interview</button>
    <button id="nextRoundBtn" style="display: none;" onclick="startNextRound()">‚è≠Ô∏è Next Round</button>
    <button id="restartInterviewBtn" style="display: none;" onclick="restartInterview()">üîÑ Restart Interview</button>
  </div>

  <div id="evaluation">
    <h3>üìä Interview Evaluation Report</h3>
    <pre id="summaryText"></pre>
  </div>

  <script>
    let currentSessionId = null;
    let currentRound = "Technical";
    let isProcessing = false;
    let interviewActive = false;

    const roundSequence = ["Technical", "Communication", "HR"];
    const roundDots = {
      "Technical": "tech-dot",
      "Communication": "comm-dot", 
      "HR": "hr-dot"
    };

    function updateProgressIndicator(round) {
      // Reset all dots
      Object.values(roundDots).forEach(dotId => {
        const dot = document.getElementById(dotId);
        dot.classList.remove("active", "completed");
      });

      // Mark completed rounds
      const currentIndex = roundSequence.indexOf(round);
      for (let i = 0; i < currentIndex; i++) {
        const dotId = roundDots[roundSequence[i]];
        document.getElementById(dotId).classList.add("completed");
      }

      // Mark current round as active
      if (currentIndex >= 0) {
        const dotId = roundDots[round];
        document.getElementById(dotId).classList.add("active");
      }
    }

    function setBlinking(speaker) {
      document.getElementById("aiIcon").classList.remove("blink");
      document.getElementById("userIcon").classList.remove("blink");

      if (speaker === "ai") {
        document.getElementById("aiIcon").classList.add("blink");
        setStatus("ü§ñ AI is speaking...");
      } else if (speaker === "user") {
        document.getElementById("userIcon").classList.add("blink");
        setStatus("üé§ Listening for your response...");
      } else {
        setStatus("üí≠ Processing...");
      }
    }

    function setStatus(text, isLoading = false) {
      const statusElement = document.getElementById("status");
      if (isLoading) {
        statusElement.innerHTML = `<span class="loading"></span> ${text}`;
      } else {
        statusElement.innerText = text;
      }
    }

    async function playAudio(path, fallbackText) {
      if (!path && fallbackText) {
        console.warn("Using browser TTS fallback");
        const synth = new SpeechSynthesisUtterance(fallbackText);
        synth.lang = "en-IN";
        synth.rate = 1.1;
        window.speechSynthesis.speak(synth);
        
        return new Promise(resolve => {
          synth.onend = () => {
            setBlinking(null);
            resolve();
          };
        });
      }

      try {
        const audio = new Audio(path);
        await audio.play();

        return new Promise(resolve => {
          audio.onended = () => {
            setBlinking(null);
            resolve();
          };
        });
      } catch (e) {
        console.error("Audio playback error:", e);
        setBlinking(null);
      }
    }

    async function startInterview() {
      if (isProcessing) return;
      
      try {
        setStatus("üöÄ Initializing interview system...", true);
        isProcessing = true;
        interviewActive = true;

        // Hide start button
        document.getElementById("startInterviewBtn").style.display = "none";
        document.getElementById("nextRoundBtn").style.display = "none";
        document.getElementById("restartInterviewBtn").style.display = "none";
        document.getElementById("evaluation").style.display = "none";

        // Start interview
        const response = await fetch("/start_interview");
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        currentSessionId = data.session_id;
        currentRound = data.round;

        document.getElementById("roundLabel").innerText = `Round: ${currentRound}`;
        updateProgressIndicator(currentRound);

        setBlinking("ai");
        await playAudio(data.audio_path, data.question);

        // Start the conversation loop
        setTimeout(() => startConversationLoop(), 1000);

      } catch (error) {
        console.error("Error starting interview:", error);
        setStatus(`‚ùå Error: ${error.message}`);
        document.getElementById("startInterviewBtn").style.display = "inline-block";
      } finally {
        isProcessing = false;
      }
    }

    async function startConversationLoop() {
      if (!interviewActive || isProcessing) return;

      try {
        isProcessing = true;
        setBlinking("user");

        const response = await fetch("/record_and_respond", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id: currentSessionId })
        });

        const data = await response.json();

        if (data.error) {
          if (data.retry) {
            setStatus(`‚ö†Ô∏è ${data.error}. Please try again.`);
            setTimeout(() => startConversationLoop(), 2000);
            return;
          } else {
            throw new Error(data.error);
          }
        }

        setBlinking("ai");

        // Handle different response types
        if (data.round_complete) {
          // Round transition
          await playAudio(data.audio_path, data.response);
          handleRoundTransition(data);
        } else if (data.interview_complete) {
          // Interview complete
          await playAudio(data.audio_path, data.response);
          await handleInterviewComplete();
        } else if (data.continue) {
          // Continue current round
          await playAudio(data.audio_path, data.response);
          setTimeout(() => startConversationLoop(), 1000);
        } else {
          // Default case - continue conversation
          if (data.response && data.audio_path) {
            await playAudio(data.audio_path, data.response);
            setTimeout(() => startConversationLoop(), 1000);
          } else {
            setTimeout(() => startConversationLoop(), 2000);
          }
        }

      } catch (error) {
        console.error("Conversation error:", error);
        setStatus(`‚ùå Error: ${error.message}`);
        interviewActive = false;
        document.getElementById("restartInterviewBtn").style.display = "inline-block";
      } finally {
        isProcessing = false;
      }
    }

    function handleRoundTransition(data) {
      interviewActive = false;
      currentRound = data.next_round;
      
      setStatus(`‚úÖ ${data.current_round} round completed!`);
      updateProgressIndicator(currentRound);
      
      document.getElementById("roundLabel").innerText = `Next: ${currentRound}`;
      document.getElementById("nextRoundBtn").style.display = "inline-block";
    }

    async function startNextRound() {
      if (isProcessing) return;

      try {
        setStatus("üîÑ Starting next round...", true);
        isProcessing = true;
        interviewActive = true;

        document.getElementById("nextRoundBtn").style.display = "none";

        const response = await fetch(`/start_next_round?session_id=${currentSessionId}`);
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        document.getElementById("roundLabel").innerText = `Round: ${data.round}`;
        updateProgressIndicator(data.round);

        setBlinking("ai");
        await playAudio(data.audio_path, data.question);

        setTimeout(() => startConversationLoop(), 1000);

      } catch (error) {
        console.error("Error starting next round:", error);
        setStatus(`‚ùå Error: ${error.message}`);
        document.getElementById("nextRoundBtn").style.display = "inline-block";
      } finally {
        isProcessing = false;
      }
    }

    async function handleInterviewComplete() {
      try {
        setStatus("üìä Generating evaluation report...", true);
        
        const response = await fetch(`/evaluate?session_id=${currentSessionId}`);
        const data = await response.json();

        // Update progress indicator
        Object.values(roundDots).forEach(dotId => {
          document.getElementById(dotId).classList.remove("active");
          document.getElementById(dotId).classList.add("completed");
        });

        document.getElementById("roundLabel").innerText = "Interview Complete";
        document.getElementById("evaluation").style.display = "block";
        document.getElementById("summaryText").innerText = data.evaluation;

        setStatus("üéâ Interview completed successfully!");
        document.getElementById("restartInterviewBtn").style.display = "inline-block";

        // Optional: Read the evaluation aloud
        setTimeout(() => {
          playAudio(null, data.evaluation);
        }, 1000);

      } catch (error) {
        console.error("Error generating evaluation:", error);
        setStatus(`‚ùå Evaluation error: ${error.message}`);
        document.getElementById("restartInterviewBtn").style.display = "inline-block";
      }
    }

    function restartInterview() {
      // Reset all state
      currentSessionId = null;
      currentRound = "Technical";
      isProcessing = false;
      interviewActive = false;

      // Reset UI
      document.getElementById("roundLabel").innerText = "Ready to Begin";
      document.getElementById("evaluation").style.display = "none";
      document.getElementById("summaryText").innerText = "";
      document.getElementById("restartInterviewBtn").style.display = "none";
      document.getElementById("nextRoundBtn").style.display = "none";
      document.getElementById("startInterviewBtn").style.display = "inline-block";

      // Reset progress indicator
      Object.values(roundDots).forEach(dotId => {
        const dot = document.getElementById(dotId);
        dot.classList.remove("active", "completed");
      });

      setBlinking(null);
      setStatus("Click 'Start Interview' to begin your AI-powered interview experience");
    }

    // Handle page visibility changes
    document.addEventListener("visibilitychange", () => {
      if (document.hidden && interviewActive) {
        console.log("Page hidden during interview");
      }
    });

    // Prevent accidental page refresh during interview
    window.addEventListener("beforeunload", (e) => {
      if (interviewActive) {
        e.preventDefault();
        e.returnValue = "Interview in progress. Are you sure you want to leave?";
      }
    });
  </script>
</body>
</html>