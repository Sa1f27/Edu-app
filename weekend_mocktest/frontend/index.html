<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Test API - Testing Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .path-info {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #1565c0;
        }

        .api-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .api-section h3 {
            color: #764ba2;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn.danger {
            background: #e74c3c;
        }

        .btn.danger:hover {
            background: #c0392b;
        }

        .response-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .test-flow {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .question-area {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .options-container {
            display: none;
            margin-top: 10px;
        }

        .option-item {
            margin: 5px 0;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .option-item:hover {
            background: #f0f0f0;
        }

        .option-item.selected {
            background: #667eea;
            color: white;
        }

        .endpoint-list {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Weekend Mock Test API - Testing Interface</h1>
            <p>Testing interface for the Weekend Mock Test sub-application</p>
            
            <div class="path-info">
                <strong>API Base URL:</strong> <span id="api-base-url"></span><br>
                <strong>Current Location:</strong> <span id="current-location"></span><br>
                <strong>Sub-app Path:</strong> /weekend_mocktest/
            </div>
            
            <div id="health-status" class="status info">
                Checking API health...
            </div>
        </div>

        <!-- Available Endpoints -->
        <div class="api-section">
            <h3>📋 Available API Endpoints</h3>
            <div class="endpoint-list">
                GET /api/health - Health check<br>
                POST /api/test/start - Start new test<br>
                POST /api/test/submit - Submit answer<br>
                GET /api/test/results/{test_id} - Get results<br>
                GET /api/test/pdf/{test_id} - Download PDF<br>
                GET /api/tests - Get all tests<br>
                GET /api/tests/{test_id} - Get specific test<br>
                DELETE /api/cleanup - Cleanup resources<br>
                GET /api/debug/status - Debug information
            </div>
        </div>

        <!-- Test Flow Section -->
        <div class="test-flow">
            <h3>🚀 Quick Test Flow</h3>
            <p>1. Check API Health → 2. Start Test → 3. Submit Answers → 4. View Results → 5. Download PDF</p>
        </div>

        <div class="grid">
            <!-- Left Column -->
            <div>
                <!-- Health Check -->
                <div class="api-section">
                    <h3>1. Health Check</h3>
                    <button class="btn" onclick="checkHealth()">Check API Health</button>
                    <button class="btn" onclick="debugStatus()">Debug Status</button>
                    <div id="health-response" class="response-area" style="display: none;"></div>
                </div>

                <!-- Start Test -->
                <div class="api-section">
                    <h3>2. Start Test</h3>
                    <div class="form-group">
                        <label>User Type:</label>
                        <select id="userType">
                            <option value="dev">Developer</option>
                            <option value="non_dev">Non-Developer</option>
                        </select>
                    </div>
                    <button class="btn" onclick="startTest()">Start Test</button>
                    <div id="start-response" class="response-area" style="display: none;"></div>
                </div>

                <!-- Current Question Display -->
                <div class="question-area" id="question-area" style="display: none;">
                    <h4>Current Question:</h4>
                    <div id="question-content"></div>
                    <div id="options-container" class="options-container">
                        <h5>Select an option:</h5>
                        <div id="options-list"></div>
                    </div>
                    <div id="text-answer-container" style="display: none;">
                        <label>Your Answer:</label>
                        <textarea id="text-answer" rows="4" placeholder="Enter your answer here..."></textarea>
                    </div>
                    <button class="btn" onclick="submitCurrentAnswer()">Submit Answer</button>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- Submit Answer -->
                <div class="api-section">
                    <h3>3. Submit Answer (Manual)</h3>
                    <div class="form-group">
                        <label>Test ID:</label>
                        <input type="text" id="testId" placeholder="Enter test ID">
                    </div>
                    <div class="form-group">
                        <label>Question Number:</label>
                        <input type="number" id="questionNumber" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Answer:</label>
                        <textarea id="answer" rows="3" placeholder="Enter answer or option index (0-3 for MCQ)"></textarea>
                    </div>
                    <button class="btn" onclick="submitAnswer()">Submit Answer</button>
                    <div id="submit-response" class="response-area" style="display: none;"></div>
                </div>

                <!-- Get Results -->
                <div class="api-section">
                    <h3>4. Get Results</h3>
                    <div class="form-group">
                        <label>Test ID:</label>
                        <input type="text" id="resultsTestId" placeholder="Enter test ID">
                    </div>
                    <button class="btn" onclick="getResults()">Get Results</button>
                    <button class="btn" onclick="downloadPDF()">Download PDF</button>
                    <div id="results-response" class="response-area" style="display: none;"></div>
                </div>

                <!-- Get All Tests -->
                <div class="api-section">
                    <h3>5. Get All Tests</h3>
                    <button class="btn" onclick="getAllTests()">Get All Tests</button>
                    <button class="btn danger" onclick="cleanup()">Cleanup Resources</button>
                    <div id="all-tests-response" class="response-area" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Automatically detect correct API base
        function getApiBase() {
            const currentPath = window.location.pathname;
            const origin = window.location.origin;
            
            // Check if we're in the sub-app context
            if (currentPath.startsWith('/weekend_mocktest')) {
                return origin + '/weekend_mocktest/api';
            } else {
                // Fallback - assume we're testing directly
                return origin + '/weekend_mocktest/api';
            }
        }
        
        const API_BASE = getApiBase();
        
        // Display current configuration
        document.getElementById('api-base-url').textContent = API_BASE;
        document.getElementById('current-location').textContent = window.location.href;
        
        // Global variables for test flow
        let currentTestId = null;
        let currentQuestionNumber = 1;
        let currentUserType = null;
        let selectedOption = null;

        // Utility functions
        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = JSON.stringify(data, null, 2);
            element.style.background = isError ? '#e74c3c' : '#2c3e50';
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('health-status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function makeRequest(url, options = {}) {
            const fullUrl = API_BASE + url;
            console.log('Making request to:', fullUrl);
            
            return fetch(fullUrl, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });
        }

        // API Functions
        async function checkHealth() {
            try {
                const response = await makeRequest('/health');
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('API is healthy ✅', 'success');
                    showResponse('health-response', data);
                } else {
                    updateStatus('API health check failed ❌', 'error');
                    showResponse('health-response', data, true);
                }
            } catch (error) {
                updateStatus('API connection failed ❌', 'error');
                showResponse('health-response', { 
                    error: error.message,
                    attempted_url: API_BASE + '/health'
                }, true);
            }
        }

        async function debugStatus() {
            try {
                const response = await makeRequest('/debug/status');
                const data = await response.json();
                showResponse('health-response', data, !response.ok);
            } catch (error) {
                showResponse('health-response', { 
                    error: error.message,
                    attempted_url: API_BASE + '/debug/status'
                }, true);
            }
        }

        async function startTest() {
            try {
                const userType = document.getElementById('userType').value;
                currentUserType = userType;
                
                const response = await makeRequest('/test/start', {
                    method: 'POST',
                    body: JSON.stringify({ user_type: userType })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentTestId = data.test_id;
                    currentQuestionNumber = data.question_number;
                    
                    // Auto-fill test ID in other sections
                    document.getElementById('testId').value = currentTestId;
                    document.getElementById('resultsTestId').value = currentTestId;
                    document.getElementById('questionNumber').value = currentQuestionNumber;
                    
                    // Display question
                    displayQuestion(data);
                    
                    updateStatus(`Test started successfully! ID: ${currentTestId.substring(0, 8)}...`, 'success');
                    showResponse('start-response', data);
                } else {
                    updateStatus('Failed to start test ❌', 'error');
                    showResponse('start-response', data, true);
                }
            } catch (error) {
                updateStatus('Test start failed ❌', 'error');
                showResponse('start-response', { error: error.message }, true);
            }
        }

        function displayQuestion(questionData) {
            const questionArea = document.getElementById('question-area');
            const questionContent = document.getElementById('question-content');
            const optionsContainer = document.getElementById('options-container');
            const textAnswerContainer = document.getElementById('text-answer-container');
            
            questionArea.style.display = 'block';
            questionContent.innerHTML = questionData.question_html;
            
            if (questionData.options) {
                // Multiple choice question
                optionsContainer.style.display = 'block';
                textAnswerContainer.style.display = 'none';
                
                const optionsList = document.getElementById('options-list');
                optionsList.innerHTML = '';
                
                questionData.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-item';
                    optionDiv.textContent = `${String.fromCharCode(65 + index)}) ${option}`;
                    optionDiv.onclick = () => selectOption(index, optionDiv);
                    optionsList.appendChild(optionDiv);
                });
            } else {
                // Text answer question
                optionsContainer.style.display = 'none';
                textAnswerContainer.style.display = 'block';
            }
        }

        function selectOption(index, element) {
            // Remove previous selection
            document.querySelectorAll('.option-item').forEach(el => el.classList.remove('selected'));
            // Add selection to current
            element.classList.add('selected');
            selectedOption = index;
        }

        async function submitCurrentAnswer() {
            if (!currentTestId) {
                alert('No active test. Please start a test first.');
                return;
            }

            let answer;
            if (selectedOption !== null) {
                answer = selectedOption.toString();
            } else {
                answer = document.getElementById('text-answer').value.trim();
            }

            if (!answer) {
                alert('Please provide an answer.');
                return;
            }

            try {
                const response = await makeRequest('/test/submit', {
                    method: 'POST',
                    body: JSON.stringify({
                        test_id: currentTestId,
                        question_number: currentQuestionNumber,
                        answer: answer
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.test_completed) {
                        // Test completed
                        document.getElementById('question-area').style.display = 'none';
                        updateStatus(`Test completed! Score: ${data.score}/${data.total_questions}`, 'success');
                        showResponse('submit-response', data);
                    } else if (data.next_question) {
                        // Next question
                        currentQuestionNumber = data.next_question.question_number;
                        document.getElementById('questionNumber').value = currentQuestionNumber;
                        displayQuestion(data.next_question);
                        selectedOption = null; // Reset selection
                        document.getElementById('text-answer').value = ''; // Reset text answer
                        updateStatus(`Answer submitted. Next question loaded.`, 'info');
                        showResponse('submit-response', data);
                    }
                } else {
                    updateStatus('Failed to submit answer ❌', 'error');
                    showResponse('submit-response', data, true);
                }
            } catch (error) {
                updateStatus('Answer submission failed ❌', 'error');
                showResponse('submit-response', { error: error.message }, true);
            }
        }

        async function submitAnswer() {
            try {
                const testId = document.getElementById('testId').value;
                const questionNumber = parseInt(document.getElementById('questionNumber').value);
                const answer = document.getElementById('answer').value;

                if (!testId || !answer) {
                    alert('Please fill in all fields.');
                    return;
                }

                const response = await makeRequest('/test/submit', {
                    method: 'POST',
                    body: JSON.stringify({
                        test_id: testId,
                        question_number: questionNumber,
                        answer: answer
                    })
                });

                const data = await response.json();
                showResponse('submit-response', data, !response.ok);
            } catch (error) {
                showResponse('submit-response', { error: error.message }, true);
            }
        }

        async function getResults() {
            try {
                const testId = document.getElementById('resultsTestId').value;
                if (!testId) {
                    alert('Please enter a test ID.');
                    return;
                }

                const response = await makeRequest(`/test/results/${testId}`);
                const data = await response.json();
                showResponse('results-response', data, !response.ok);
            } catch (error) {
                showResponse('results-response', { error: error.message }, true);
            }
        }

        async function downloadPDF() {
            try {
                const testId = document.getElementById('resultsTestId').value;
                if (!testId) {
                    alert('Please enter a test ID.');
                    return;
                }

                const response = await makeRequest(`/test/pdf/${testId}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `mock_test_results_${testId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    updateStatus('PDF downloaded successfully ✅', 'success');
                } else {
                    const data = await response.json();
                    showResponse('results-response', data, true);
                }
            } catch (error) {
                showResponse('results-response', { error: error.message }, true);
            }
        }

        async function getAllTests() {
            try {
                const response = await makeRequest('/tests');
                const data = await response.json();
                showResponse('all-tests-response', data, !response.ok);
            } catch (error) {
                showResponse('all-tests-response', { error: error.message }, true);
            }
        }

        async function cleanup() {
            try {
                const response = await makeRequest('/cleanup', { method: 'DELETE' });
                const data = await response.json();
                showResponse('all-tests-response', data, !response.ok);
                
                if (response.ok) {
                    updateStatus('Resources cleaned up ✅', 'success');
                }
            } catch (error) {
                showResponse('all-tests-response', { error: error.message }, true);
            }
        }

        // Initialize page
        window.onload = function() {
            console.log('Initializing with API base:', API_BASE);
            checkHealth();
        };
    </script>
</body>
</html>